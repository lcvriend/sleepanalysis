<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slaapanalyse</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vega-lite@5.9.0"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <link rel="stylesheet" href="static/stylesheet.css">
    <style>
    </style>
</head>
<body>
    <header>
        <h1>Slaapanalyse</h1>
        <img src="static/noun-sleep-disorder-5145226.svg" alt="">
    </header>
    <main>
        <section class="no-print">
            <h2>Laad data <span>(Dit gedeelte wordt niet geprint/geëxporteerd)</span></h2>
            <details>
                <summary>Bekijk <strong>instructies</strong></summary>
                <div class="instructions">
                    <div>
                        <p>Sla observaties op als <a href="https://nl.wikipedia.org/wiki/Kommagescheiden_bestand">csv-bestand</a>.</p>
                        <p>Deze velden zijn verplicht:</p>
                        <ol>
                            <li>Sessie</li>
                            <li>Datum (<code>YYYYMMDD</code>)</li>
                            <li>Tijd (<code>HH:MM:SS</code>)</li>
                            <li>Status</li>
                        </ol>
                    </div>
                    <div>
                        <p>Gebruik de volgende statussen:</p>
                        <ul>
                            <li>Inslapen</li>
                            <li>Slapen</li>
                            <li>Wakker</li>
                            <li>Waken</li>
                            <li>Uit bed</li>
                        </ul>
                        <p>
                            Zie <a href="https://github.com/lcvriend/sleepanalysis/blob/master/data/example.csv">een voorbeeld.</a>
                        </p>
                    </div>
                </div>
            </details>
            <div class="controls">
                <div class="loader-file">
                    <label for="fileInput">Selecteer een csv bestand:</label>
                    <input type="file" id="fileInput" autocomplete="off">
                </div>
                <div class="loader-example">
                    <label for="loadExample">Of laad een voorbeeldbestand:</label>
                    <button id="loadExample">Laad voorbeeld</button>
                </div>
            </div>
            <div id="errorMessage" class="issue"></div>
        </section>
        <section>
            <h2>Toelichting</h2>
            <p>
                Een slaapanalyse is een methode binnen de orthopedagogiek om slaapproblemen in kaart te brengen. Hierbij wordt gedurende een aantal nachten het slaappatroon geobserveerd en geregistreerd. In deze slaapanalyse wordt het slaappatroon geanalyseerd op basis van de volgende indicatoren:
            </p>
            <table>
                <thead>
                    <tr>
                        <th>Indicator</th>
                        <th>Variabele</th>
                        <th>Norm</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th>Slaapduur</th>
                        <td>Totaalduur slapen</td>
                        <td>Minstens 7 uur per nacht (<a href="https://doi.org/10.1016/j.socscimed.2010.05.041">Buxton &amp; Marcelli, 2010</a>)</td>
                    </tr>
                    <tr>
                        <th>Slaapefficiëntie</th>
                        <td>Verhouding in bed/slapen</td>
                        <td>Minstens 85% (<a href="https://psycnet.apa.org/doi/10.1037/a0028204">Astill e.a., 2012</a>)</td>
                    </tr>
                    <tr>
                        <th rowspan="3">Slaapcontinuïteit</th>
                        <td>Inslaapduur</td>
                        <td>Binnen 30 min.</td>
                    </tr>
                    <tr>
                        <td>Aantal keer wakker</td>
                        <td>Max. 2 keer wakker</td>
                    </tr>
                    <tr>
                        <td>Totaal duur wakker</td>
                        <td>Minder dan 90 min. wakker na inslapen</td>
                    </tr>
                </tbody>
            </table>
        </section>
        <section class="output hide">
            <h2>Gegevens</h2>
            <div id="metadata"></div>
        </section>
        <section class="output hide">
            <h2>Tabel</h2>
            <p>
                Onderstaande tabel bevat de slaapkwantificatie per sessie en gemiddeld voor de gehele observatieduur. Indien een variabele rood is gemarkeerd betekent dit dat de gestelde norm voor een gezond slaappatroon is overschreden.
            </p>
            <div id="table"></div>
        </section>
        <section class="output hide">
            <h2>Grafieken</h2>
            <div id="chart-timelines"></div>
            <div id="chart-percentages"></div>
        </section>
        <section>
            <h2>Overige informatie</h2>
            <p>Deze tool is ontwikkeld door:</p>
            <ul>
                <li>L.P.H. Vriend</li>
                <li>L.C. Vriend</li>
            </ul>
            <p>De code is onder <a href="https://www.gnu.org/licenses/gpl-3.0.en.html">GPLv3</a> open source beschikbaar; zie <a href="https://github.com/lcvriend/sleepanalysis">github.com/lcvriend/sleepanalysis</a>.</p>
            <p>De grafieken worden gegenereerd met <a href="https://vega.github.io/vega-lite/">Vega-Lite</a>.</p>
        </section>
    </main>
<script type="module">
    import { analyzeSleepPatterns } from "./src/sleepanalysis.js"
    import { Data } from "./src/data.js"
    import { views } from "./src/chart.js"

    const loadExample = document.getElementById("loadExample")
    const fileInput = document.getElementById("fileInput")
    const outputSections = document.querySelectorAll(".output")
    const errorMessage = document.getElementById("errorMessage")
    const elementIds = {
        timelines: "#chart-timelines",
        percentages: "#chart-percentages",
        table: "#table",
        metadata: "#metadata",
    }

    fileInput.addEventListener("change", event => {
        const file = event.target.files[0]
        const reader = new FileReader()
        reader.readAsText(file)
        reader.onload = (event) => {
            const source = event.target.result
            const data = Data.fromCSV(source, handleError)
            analyzeSleepPatterns(data, elementIds)
            showOutputSections()
        }
    })

    loadExample.addEventListener("click", () => {
        fetch("data/example.csv")
            .then(response => response.text())
            .then(source => {
                const data = Data.fromCSV(source, handleError)
                analyzeSleepPatterns(data, elementIds)
                showOutputSections()
            })
            .catch(error => {
                console.error("Error:", error)
            })
    })

    function showOutputSections() {
        errorMessage.innerHTML = ""
        outputSections.forEach(section => section.classList.remove("hide"))
        outputSections[0].scrollIntoView({ behavior: "smooth" })
    }

    function handleError(error) {
        console.error("Error:", error)
        errorMessage.innerHTML = "<strong>Foutmelding!</strong> er is iets mis met het csv bestand."
    }

</script>
</body>
